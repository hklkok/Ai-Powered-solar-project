<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Environmental Monitor Pro - 5 Sensors</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            /* Sophisticated Dark Theme */
            --bg-primary: #0a0e1a;
            --bg-secondary: #111827;
            --bg-card: rgba(17, 24, 39, 0.7);
            --bg-card-hover: rgba(17, 24, 39, 0.9);
            
            /* Accent Colors - Vibrant but refined */
            --accent-temp: #ef4444;
            --accent-humidity: #3b82f6;
            --accent-dust: #f59e0b;
            --accent-pressure: #a78bfa;
            --accent-solar: #10b981;
            --accent-weather: #8b5cf6;
            
            /* Gradients */
            --gradient-hero: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-temp: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --gradient-hum: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --gradient-dust: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            --gradient-pressure: linear-gradient(135deg, #a78bfa 0%, #8b5cf6 100%);
            --gradient-solar: linear-gradient(135deg, #30cfd0 0%, #330867 100%);
            
            /* Text Colors */
            --text-primary: #f9fafb;
            --text-secondary: #9ca3af;
            --text-muted: #6b7280;
            
            /* Borders & Effects */
            --border-color: rgba(255, 255, 255, 0.1);
            --glow: 0 0 30px rgba(102, 126, 234, 0.3);
            
            /* Typography */
            --font-display: 'Space Grotesk', sans-serif;
            --font-body: 'Inter', sans-serif;
        }
        
        body {
            font-family: var(--font-body);
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow-x: hidden;
            position: relative;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* Animated Background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 50%, rgba(102, 126, 234, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(118, 75, 162, 0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 0 2rem;
            position: relative;
            z-index: 1;
            flex: 1;
        }
        
        /* Header */
        .header {
            padding: 3rem 0;
            margin-bottom: 2rem;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 2rem;
        }
        
        .logo-section {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }
        
        .logo-icon {
            width: 60px;
            height: 60px;
            background: var(--gradient-hero);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            box-shadow: 0 8px 32px rgba(102, 126, 234, 0.4);
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        .title-group h1 {
            font-family: var(--font-display);
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
            letter-spacing: -0.5px;
        }
        
        .title-group p {
            color: var(--text-secondary);
            font-size: 0.95rem;
            letter-spacing: 0.5px;
        }
        
        .status-pill {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1.5rem;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 50px;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }
        
        .status-pill:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
        }
        
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #10b981;
            animation: pulse-dot 2s infinite;
        }
        
        @keyframes pulse-dot {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.1); }
        }
        
        .status-dot.disconnected {
            background: #ef4444;
        }
        
        /* Main Grid Layout - Updated for 5 cards */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(15, 1fr);
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        /* Sensor Cards */
        .sensor-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 24px;
            padding: 2rem;
            backdrop-filter: blur(10px);
            /* Only transition visual props ‚Äî never size/layout props */
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1),
                        box-shadow 0.4s cubic-bezier(0.4, 0, 0.2, 1),
                        background 0.4s ease,
                        border-color 0.4s ease;
            position: relative;
            overflow: hidden;
            /* Lock height so value changes never reflow the grid */
            min-height: 210px;
            box-sizing: border-box;
        }
        
        .sensor-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, transparent 0%, rgba(255, 255, 255, 0.05) 100%);
            opacity: 0;
            transition: opacity 0.4s ease;
        }
        
        .sensor-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            background: var(--bg-card-hover);
            border-color: rgba(255, 255, 255, 0.2);
        }
        
        .sensor-card:hover::before {
            opacity: 1;
        }
        
        .card-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .card-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            position: relative;
        }
        
        .card-icon::after {
            content: '';
            position: absolute;
            inset: -4px;
            border-radius: 12px;
            padding: 2px;
            background: inherit;
            opacity: 0.3;
            z-index: -1;
        }
        
        .card-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }
        
        .card-value {
            font-size: 3rem;
            font-weight: 700;
            font-family: var(--font-display);
            margin-bottom: 1rem;
            line-height: 1;
            /* Fixed height prevents number-length changes from shifting layout */
            min-height: 3.2rem;
            display: flex;
            align-items: baseline;
            gap: 0.15rem;
            /* Smooth value color changes */
            transition: color 0.6s ease;
            /* ADD this line */
            letter-spacing: -1px;
        }
        
        .card-unit {
            font-size: 1.25rem;
            color: var(--text-secondary);
            font-weight: 400;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 100px;
            overflow: hidden;
            margin: 1.5rem 0;
        }
        
        .progress-fill {
            height: 100%;
            border-radius: 100px;
            transition: width 1s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }
        
        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 100px;
            font-size: 0.8rem;
            font-weight: 600;
            letter-spacing: 0.5px;
            /* Lock size so text changes never push layout */
            min-height: 2.1rem;
            min-width: 110px;
            white-space: nowrap;
            /* Smooth transitions for status color changes */
            transition: background 0.5s ease, color 0.5s ease, border-color 0.5s ease;
        }
        
        /* Temperature Card */
        .temp-card {
            grid-column: span 3;
        }
        
        .temp-card .card-icon {
            background: var(--gradient-temp);
        }
        
        .temp-card .card-value {
            color: var(--accent-temp);
        }
        
        .temp-card .progress-fill {
            background: var(--gradient-temp);
        }
        
        /* Humidity Card */
        .hum-card {
            grid-column: span 3;
        }
        
        .hum-card .card-icon {
            background: var(--gradient-hum);
        }
        
        .hum-card .card-value {
            color: var(--accent-humidity);
        }
        
        .hum-card .progress-fill {
            background: var(--gradient-hum);
        }
        
        /* Dust Card */
        .dust-card {
            grid-column: span 3;
        }
        
        .dust-card .card-icon {
            background: var(--gradient-dust);
        }
        
        .dust-card .card-value {
            color: var(--accent-dust);
        }
        
        .dust-card .progress-fill {
            background: var(--gradient-dust);
        }
        
        /* Air Pressure Card - NEW! */
        .pressure-card {
            grid-column: span 3;
        }
        
        .pressure-card .card-icon {
            background: var(--gradient-pressure);
        }
        
        .pressure-card .card-value {
            color: var(--accent-pressure);
        }
        
        .pressure-card .progress-fill {
            background: var(--gradient-pressure);
        }
        
        /* Solar Card */
        .solar-card {
            grid-column: span 3;
        }
        
        .solar-card .card-icon {
            background: var(--gradient-solar);
        }
        
        .solar-card .card-value {
            color: var(--accent-solar);
        }
        
        .solar-card .progress-fill {
            background: var(--gradient-solar);
        }
        
        /* Weather Widget */
        .weather-widget {
            grid-column: span 5;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 24px;
            padding: 2rem;
            backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
        }
        
        .weather-widget::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(139, 92, 246, 0.1) 0%, transparent 70%);
            animation: weather-glow 8s ease-in-out infinite;
        }
        
        @keyframes weather-glow {
            0%, 100% { transform: translate(0, 0) scale(1); }
            50% { transform: translate(-10%, -10%) scale(1.1); }
        }
        
        .weather-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
            position: relative;
            z-index: 1;
        }
        
        .weather-icon-large {
            font-size: 3rem;
        }
        
        .weather-temp-main {
            font-size: 3rem;
            font-weight: 700;
            font-family: var(--font-display);
        }
        
        .weather-description {
            color: var(--text-secondary);
            text-transform: capitalize;
            font-size: 1.1rem;
        }
        
        .weather-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-top: 1.5rem;
            position: relative;
            z-index: 1;
        }
        
        .weather-detail-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
        }
        
        .weather-detail-icon {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(139, 92, 246, 0.2);
            border-radius: 8px;
            color: #a78bfa;
        }
        
        /* Air Quality Analysis */
        .air-quality-panel {
            grid-column: span 10;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 24px;
            padding: 2rem;
            backdrop-filter: blur(10px);
        }
        
        .panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 2rem;
        }
        
        .panel-title {
            font-family: var(--font-display);
            font-size: 1.75rem;
            font-weight: 600;
        }
        
        .aqi-display {
            display: flex;
            align-items: center;
            gap: 2rem;
            min-height: 140px;
            /* Smooth content transitions in AQI panel */
            transition: all 0.5s ease;
        }
        
        .aqi-circle {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            background: rgba(255, 255, 255, 0.05);
        }
        
        .aqi-value {
            font-size: 2.5rem;
            font-weight: 700;
            font-family: var(--font-display);
        }
        
        .aqi-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .aqi-info h3 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }
        
        .aqi-description {
            color: var(--text-secondary);
            line-height: 1.6;
        }
        
        /* Solar Tracker Visualization */
        .solar-tracker-panel {
            grid-column: span 15;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 24px;
            padding: 2.5rem;
            backdrop-filter: blur(10px);
        }
        
        .tracker-3d-view {
            position: relative;
            height: 300px;
            background: linear-gradient(180deg, rgba(10, 14, 26, 0.8) 0%, rgba(17, 24, 39, 0.8) 100%);
            border-radius: 16px;
            margin: 2rem 0;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }
        
        .sky-gradient {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(180deg, 
                #1e3a8a 0%, 
                #3b82f6 30%, 
                #fbbf24 70%, 
                #f59e0b 100%);
            opacity: 0.3;
        }
        
        .sun {
            position: absolute;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: radial-gradient(circle, #fef3c7 0%, #fbbf24 100%);
            box-shadow: 0 0 60px #fbbf24, 0 0 120px #f59e0b;
            animation: sun-glow 3s ease-in-out infinite;
            transition: all 1s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        @keyframes sun-glow {
            0%, 100% { box-shadow: 0 0 60px #fbbf24, 0 0 120px #f59e0b; }
            50% { box-shadow: 0 0 80px #fbbf24, 0 0 160px #f59e0b; }
        }
        
        .solar-panel {
            position: absolute;
            bottom: 60px;
            left: 50%;
            transform: translateX(-50%);
            width: 200px;
            height: 100px;
            perspective: 1000px;
        }
        
        .panel-surface {
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            border: 3px solid #64748b;
            border-radius: 8px;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 1s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }
        
        .panel-surface::before {
            content: '';
            position: absolute;
            inset: 8px;
            background: repeating-linear-gradient(
                0deg,
                #475569 0px,
                #475569 2px,
                transparent 2px,
                transparent 22px
            ),
            repeating-linear-gradient(
                90deg,
                #475569 0px,
                #475569 2px,
                transparent 2px,
                transparent 22px
            );
            border-radius: 4px;
        }
        
        .panel-stand {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 4px;
            height: 60px;
            background: linear-gradient(180deg, #64748b 0%, #475569 100%);
        }
        
        .ldr-sensors {
            display: flex;
            justify-content: space-between;
            margin-top: 2rem;
            gap: 2rem;
        }
        
        .ldr-sensor {
            flex: 1;
            padding: 1.5rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            border: 1px solid var(--border-color);
        }
        
        .ldr-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .ldr-bulb {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #fbbf24;
            box-shadow: 0 0 20px #fbbf24;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }
        
        .ldr-value-display {
            font-size: 2rem;
            font-weight: 700;
            font-family: var(--font-display);
            color: #fbbf24;
        }
        
        .tracker-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }
        
        .stat-item {
            padding: 1.5rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            border: 1px solid var(--border-color);
            text-align: center;
        }
        
        .stat-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            font-family: var(--font-display);
        }
        
        /* Export Panel */
        .export-panel {
            grid-column: span 15;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 24px;
            padding: 2rem;
            backdrop-filter: blur(10px);
        }
        
        .export-buttons {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 1rem 2rem;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-family: var(--font-body);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            text-decoration: none;
        }
        
        .btn-primary {
            background: var(--gradient-hero);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4);
        }
        
        .btn-outline {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
        }
        
        .btn-outline:hover {
            background: rgba(255, 255, 255, 0.05);
            transform: translateY(-2px);
        }
        
        /* Footer */
        .footer {
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
            padding: 2rem 0;
            margin-top: 4rem;
            position: relative;
            z-index: 1;
        }
        
        .footer-content {
            max-width: 1600px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1.5rem;
        }
        
        .footer-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .footer-logo {
            width: 40px;
            height: 40px;
            background: var(--gradient-hero);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }
        
        .footer-text {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        .footer-text strong {
            color: var(--text-primary);
        }
        
        .footer-links {
            display: flex;
            gap: 2rem;
            align-items: center;
        }
        
        .footer-link {
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.9rem;
            transition: color 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .footer-link:hover {
            color: var(--text-primary);
        }
        
        .footer-stats {
            display: flex;
            gap: 1.5rem;
            padding: 0 1.5rem;
            border-left: 1px solid var(--border-color);
            border-right: 1px solid var(--border-color);
        }
        
        .footer-stat {
            text-align: center;
        }
        
        .footer-stat-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
        }
        
        .footer-stat-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* Responsive Design */
        @media (max-width: 1400px) {
            .temp-card, .hum-card, .dust-card, .pressure-card, .solar-card {
                grid-column: span 5;
            }
            
            .weather-widget {
                grid-column: span 7;
            }
            
            .air-quality-panel {
                grid-column: span 8;
            }
            
            .solar-tracker-panel, .export-panel {
                grid-column: span 15;
            }
        }
        
        @media (max-width: 1024px) {
            .dashboard-grid {
                grid-template-columns: repeat(12, 1fr);
            }
            
            .temp-card, .hum-card, .dust-card, .pressure-card, .solar-card {
                grid-column: span 6;
            }
            
            .weather-widget, .air-quality-panel {
                grid-column: span 12;
            }
            
            .solar-tracker-panel, .export-panel {
                grid-column: span 12;
            }
        }
        
        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: repeat(1, 1fr);
            }
            
            .temp-card, .hum-card, .dust-card, .pressure-card, .solar-card,
            .weather-widget, .air-quality-panel, .solar-tracker-panel, .export-panel {
                grid-column: span 1;
            }
            
            .title-group h1 {
                font-size: 2rem;
            }
            
            .card-value {
                font-size: 2.5rem;
            }
            
            .footer-content {
                flex-direction: column;
                text-align: center;
            }
            
            .footer-stats {
                border-left: none;
                border-right: none;
                border-top: 1px solid var(--border-color);
                border-bottom: 1px solid var(--border-color);
                padding: 1rem 0;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="container">
        <div class="header">
            <div class="header-content">
                <div class="logo-section">
                    <div class="logo-icon">
                        <i class="fas fa-satellite-dish"></i>
                    </div>
                    <div class="title-group">
                        <h1>Environmental Monitor Pro</h1>
                        <p>5 Sensors ‚Ä¢ Real-time IoT Dashboard ‚Ä¢ Advanced Analytics</p>
                    </div>
                </div>
                
                <div class="status-pill">
                    <span class="status-dot" id="statusDot"></span>
                    <div>
                        <div style="font-weight: 600;" id="statusText">Connected</div>
                        <div style="font-size: 0.75rem; color: var(--text-secondary);" id="lastUpdate">Live</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Main Dashboard Grid -->
        <div class="dashboard-grid">
            <!-- Temperature Card -->
            <div class="sensor-card temp-card">
                <div class="card-header">
                    <div class="card-icon">
                        <i class="fas fa-temperature-high"></i>
                    </div>
                    <span class="card-label"><i class="fas fa-thermometer-half"></i> Temperature</span>
                </div>
                <div class="card-value" id="tempValue">
                    --<span class="card-unit">¬∞C</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="tempBar" style="width: 0%"></div>
                </div>
                <span class="status-badge" id="tempStatus">Loading...</span>
            </div>
            
            <!-- Humidity Card -->
            <div class="sensor-card hum-card">
                <div class="card-header">
                    <div class="card-icon">
                        <i class="fas fa-droplet"></i>
                    </div>
                    <span class="card-label"><i class="fas fa-tint"></i> Humidity</span>
                </div>
                <div class="card-value" id="humValue">
                    --<span class="card-unit">%</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="humBar" style="width: 0%"></div>
                </div>
                <span class="status-badge" id="humStatus">Loading...</span>
            </div>
            
            <!-- Dust Card -->
            <div class="sensor-card dust-card">
                <div class="card-header">
                    <div class="card-icon">
                        <i class="fas fa-smog"></i>
                    </div>
                    <span class="card-label"><i class="fas fa-wind"></i> Air Quality</span>
                </div>
                <div class="card-value" id="dustValue">
                    --<span class="card-unit">¬µg/m¬≥</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="dustBar" style="width: 0%"></div>
                </div>
                <span class="status-badge" id="dustStatus">Loading...</span>
            </div>
            
            <!-- Air Pressure Card - NEW! -->
            <div class="sensor-card pressure-card">
                <div class="card-header">
                    <div class="card-icon">
                        <i class="fas fa-gauge-high"></i>
                    </div>
                    <span class="card-label"><i class="fas fa-compress-arrows-alt"></i> Air Pressure</span>
                </div>
                <div class="card-value" id="pressureValue">
                    --<span class="card-unit">kPa</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="pressureBar" style="width: 0%"></div>
                </div>
                <span class="status-badge" id="pressureStatus">Loading...</span>
            </div>
            
            <!-- Solar Angle Card -->
            <div class="sensor-card solar-card">
                <div class="card-header">
                    <div class="card-icon">
                        <i class="fas fa-solar-panel"></i>
                    </div>
                    <span class="card-label"><i class="fas fa-sun"></i> Panel Angle</span>
                </div>
                <div class="card-value" id="angleValue">
                    --<span class="card-unit">¬∞</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="angleBar" style="width: 50%"></div>
                </div>
                <span class="status-badge" id="trackerStatus">Loading...</span>
            </div>
            
            <!-- Weather Widget -->
            <div class="weather-widget">
                <div class="weather-header">
                    <div id="weatherIcon" class="weather-icon-large">
                        <i class="fas fa-cloud-sun"></i>
                    </div>
                    <div>
                        <div class="weather-temp-main" id="weatherTemp">--¬∞C</div>
                        <div class="weather-description" id="weatherDesc">Loading weather...</div>
                    </div>
                </div>
                <div class="weather-details">
                    <div class="weather-detail-item">
                        <div class="weather-detail-icon">
                            <i class="fas fa-wind"></i>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; color: var(--text-secondary);">Wind</div>
                            <div style="font-weight: 600;" id="weatherWind">-- km/h</div>
                        </div>
                    </div>
                    <div class="weather-detail-item">
                        <div class="weather-detail-icon">
                            <i class="fas fa-droplet"></i>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; color: var(--text-secondary);">Humidity</div>
                            <div style="font-weight: 600;" id="weatherHumidity">--%</div>
                        </div>
                    </div>
                    <div class="weather-detail-item">
                        <div class="weather-detail-icon">
                            <i class="fas fa-gauge-high"></i>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; color: var(--text-secondary);">Pressure</div>
                            <div style="font-weight: 600;" id="weatherPressure">-- hPa</div>
                        </div>
                    </div>
                    <div class="weather-detail-item">
                        <div class="weather-detail-icon">
                            <i class="fas fa-eye"></i>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; color: var(--text-secondary);">Visibility</div>
                            <div style="font-weight: 600;" id="weatherVisibility">-- km</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Air Quality Analysis -->
            <div class="air-quality-panel">
                <div class="panel-header">
                    <h2 class="panel-title">
                        <i class="fas fa-lungs"></i> Air Quality Analysis
                    </h2>
                </div>
                <div class="aqi-display" id="aqiDisplay">
                    <div class="aqi-circle" style="border: 4px solid #10b981;">
                        <div class="aqi-value" style="color: #10b981;">0</div>
                        <div class="aqi-label">AQI</div>
                    </div>
                    <div class="aqi-info">
                        <h3 style="color: #10b981;"><i class="fas fa-check-circle"></i> Good Air Quality</h3>
                        <p class="aqi-description">Air quality is satisfactory and poses little or no health risk. Outdoor activities are safe for everyone.</p>
                    </div>
                </div>
            </div>
            
            <!-- Solar Tracker Visualization -->
            <div class="solar-tracker-panel">
                <div class="panel-header">
                    <h2 class="panel-title">
                        <i class="fas fa-sun"></i> Solar Tracker System
                    </h2>
                </div>
                
                <!-- 3D Tracker View -->
                <div class="tracker-3d-view">
                    <div class="sky-gradient"></div>
                    <div class="sun" id="sunPosition"></div>
                    <div class="solar-panel">
                        <div class="panel-surface" id="panelSurface"></div>
                        <div class="panel-stand"></div>
                    </div>
                </div>
                
                <!-- LDR Sensors -->
                <div class="ldr-sensors">
                    <div class="ldr-sensor">
                        <div class="ldr-header">
                            <div class="ldr-bulb">
                                <i class="fas fa-lightbulb"></i>
                            </div>
                            <div>
                                <div style="font-size: 0.875rem; color: var(--text-secondary);"><i class="fas fa-arrow-left"></i> LEFT SENSOR</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">LDR-A0</div>
                            </div>
                        </div>
                        <div class="ldr-value-display" id="ldrLeft">0</div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="ldrLeftBar" style="background: linear-gradient(90deg, #fbbf24, #f59e0b); width: 0%"></div>
                        </div>
                    </div>
                    
                    <div class="ldr-sensor">
                        <div class="ldr-header">
                            <div class="ldr-bulb">
                                <i class="fas fa-lightbulb"></i>
                            </div>
                            <div>
                                <div style="font-size: 0.875rem; color: var(--text-secondary);">RIGHT SENSOR <i class="fas fa-arrow-right"></i></div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">LDR-A1</div>
                            </div>
                        </div>
                        <div class="ldr-value-display" id="ldrRight">0</div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="ldrRightBar" style="background: linear-gradient(90deg, #fbbf24, #f59e0b); width: 0%"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Tracker Stats -->
                <div class="tracker-stats">
                    <div class="stat-item">
                        <div class="stat-label"><i class="fas fa-arrows-left-right"></i> Light Difference</div>
                        <div class="stat-value" id="lightDiff">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label"><i class="fas fa-bullseye"></i> Tracker Action</div>
                        <div class="stat-value" style="font-size: 1.25rem;" id="trackerAction">CENTER</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label"><i class="fas fa-info-circle"></i> System Status</div>
                        <div class="stat-value" style="font-size: 1.25rem;" id="trackerSystemStatus">IDLE</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label"><i class="fas fa-bolt"></i> Efficiency</div>
                        <div class="stat-value" id="trackerEfficiency">--%</div>
                    </div>
                </div>
            </div>
            
            <!-- Export Panel -->
            <div class="export-panel">
                <div class="panel-header">
                    <h2 class="panel-title">
                        <i class="fas fa-download"></i> Data Export & Actions
                    </h2>
                </div>
                <div class="export-buttons">
                    <a href="/api/export/csv/1" class="btn btn-primary">
                        <i class="fas fa-file-csv"></i>
                        <span>Export 24 Hours</span>
                    </a>
                    <a href="/api/export/csv/7" class="btn btn-primary">
                        <i class="fas fa-file-csv"></i>
                        <span>Export 7 Days</span>
                    </a>
                    <a href="/api/export/csv/30" class="btn btn-primary">
                        <i class="fas fa-file-csv"></i>
                        <span>Export 30 Days</span>
                    </a>
                    <a href="/api/history" class="btn btn-outline">
                        <i class="fas fa-chart-line"></i>
                        <span>View History</span>
                    </a>
                    <a href="/api/db/stats" class="btn btn-outline">
                        <i class="fas fa-database"></i>
                        <span>Database Stats</span>
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-left">
                <div class="footer-logo">
                    <i class="fas fa-microchip"></i>
                </div>
                <div class="footer-text">
                    <strong>Environmental Monitor Pro</strong><br>
                    IoT Dashboard ‚Ä¢ Version 4.0 ‚Ä¢ 5 Sensors ‚Ä¢ Built with ‚ù§Ô∏è
                </div>
            </div>
            
            <div class="footer-stats">
                <div class="footer-stat">
                    <div class="footer-stat-value" id="footerReadings">0</div>
                    <div class="footer-stat-label">Readings</div>
                </div>
                <div class="footer-stat">
                    <div class="footer-stat-value" id="footerUptime">0s</div>
                    <div class="footer-stat-label">Uptime</div>
                </div>
                <div class="footer-stat">
                    <div class="footer-stat-value" id="footerStatus">--</div>
                    <div class="footer-stat-label">Status</div>
                </div>
            </div>
            
            <div class="footer-links">
                <a href="/api/data" class="footer-link" target="_blank">
                    <i class="fas fa-code"></i> API
                </a>
                <a href="https://github.com" class="footer-link" target="_blank">
                    <i class="fab fa-github"></i> GitHub
                </a>
                <a href="#" class="footer-link" onclick="alert('Dashboard v4.0\n5-Sensor IoT System\nTemp ‚Ä¢ Humidity ‚Ä¢ Dust ‚Ä¢ Pressure ‚Ä¢ Solar')">
                    <i class="fas fa-info-circle"></i> About
                </a>
            </div>
        </div>
    </footer>
    
    <script>
        let lastUpdateTime = Date.now();
        let startTime = Date.now();
        let readingsCount = 0;
        
        // Update dashboard data
        async function updateData() {
            try {
                const response = await fetch('/api/data');
                const data = await response.json();
                
                lastUpdateTime = Date.now();
                
                // Update connection status
                const statusDot = document.getElementById('statusDot');
                const statusText = document.getElementById('statusText');
                
                if (data.connected) {
                    statusDot.classList.remove('disconnected');
                    statusText.textContent = 'Connected';
                    readingsCount++;
                } else {
                    statusDot.classList.add('disconnected');
                    statusText.textContent = 'Disconnected';
                }
                
                document.getElementById('lastUpdate').textContent = data.time || 'Live';
                
                // Update Temperature
                if (data.temperature !== undefined) {
                    const temp = data.temperature;
                    document.getElementById('tempValue').innerHTML = `${temp.toFixed(1)}<span class="card-unit">¬∞C</span>`;
                    const tempPercent = Math.min((temp / 50) * 100, 100);
                    document.getElementById('tempBar').style.width = `${tempPercent}%`;
                    
                    const tempStatus = document.getElementById('tempStatus');
                    if (temp > 35) {
                        tempStatus.textContent = 'üî• High Temperature';
                        tempStatus.style.background = 'rgba(239, 68, 68, 0.2)';
                        tempStatus.style.color = '#ef4444';
                    } else if (temp > 25) {
                        tempStatus.textContent = '‚òÄÔ∏è Warm';
                        tempStatus.style.background = 'rgba(245, 158, 11, 0.2)';
                        tempStatus.style.color = '#f59e0b';
                    } else {
                        tempStatus.textContent = '‚úì Normal';
                        tempStatus.style.background = 'rgba(16, 185, 129, 0.2)';
                        tempStatus.style.color = '#10b981';
                    }
                }
                
                // Update Humidity
                if (data.humidity !== undefined) {
                    const hum = data.humidity;
                    document.getElementById('humValue').innerHTML = `${hum.toFixed(0)}<span class="card-unit">%</span>`;
                    document.getElementById('humBar').style.width = `${hum}%`;
                    
                    const humStatus = document.getElementById('humStatus');
                    if (hum > 70) {
                        humStatus.textContent = 'üíß High Humidity';
                        humStatus.style.background = 'rgba(59, 130, 246, 0.2)';
                        humStatus.style.color = '#3b82f6';
                    } else if (hum < 30) {
                        humStatus.textContent = 'üèúÔ∏è Low Humidity';
                        humStatus.style.background = 'rgba(245, 158, 11, 0.2)';
                        humStatus.style.color = '#f59e0b';
                    } else {
                        humStatus.textContent = '‚úì Optimal';
                        humStatus.style.background = 'rgba(16, 185, 129, 0.2)';
                        humStatus.style.color = '#10b981';
                    }
                }
                
                // Update Dust/Air Quality
                if (data.dust !== undefined) {
                    const dust = data.dust;
                    document.getElementById('dustValue').innerHTML = `${dust.toFixed(1)}<span class="card-unit">¬µg/m¬≥</span>`;
                    const dustPercent = Math.min((dust / 300) * 100, 100);
                    document.getElementById('dustBar').style.width = `${dustPercent}%`;
                    
                    const dustStatus = document.getElementById('dustStatus');
                    const aqiDisplay = document.getElementById('aqiDisplay');
                    
                    if (dust < 140) {
                        dustStatus.textContent = '‚úì Good Air';
                        dustStatus.style.background = 'rgba(16, 185, 129, 0.2)';
                        dustStatus.style.color = '#10b981';
                        
                        aqiDisplay.innerHTML = `
                            <div class="aqi-circle" style="border: 4px solid #10b981;">
                                <div class="aqi-value" style="color: #10b981;">${dust.toFixed(0)}</div>
                                <div class="aqi-label">AQI</div>
                            </div>
                            <div class="aqi-info">
                                <h3 style="color: #10b981;"><i class="fas fa-check-circle"></i> Good Air Quality</h3>
                                <p class="aqi-description">Air quality is satisfactory and poses little or no health risk. Perfect for outdoor activities.</p>
                            </div>
                        `;
                    } else if (dust < 180) {
                        dustStatus.textContent = '‚ö†Ô∏è Moderate';
                        dustStatus.style.background = 'rgba(245, 158, 11, 0.2)';
                        dustStatus.style.color = '#f59e0b';
                        
                        aqiDisplay.innerHTML = `
                            <div class="aqi-circle" style="border: 4px solid #f59e0b;">
                                <div class="aqi-value" style="color: #f59e0b;">${dust.toFixed(0)}</div>
                                <div class="aqi-label">AQI</div>
                            </div>
                            <div class="aqi-info">
                                <h3 style="color: #f59e0b;"><i class="fas fa-exclamation-triangle"></i> Moderate Air Quality</h3>
                                <p class="aqi-description">Acceptable for most people. Sensitive individuals should consider limiting prolonged outdoor activities.</p>
                            </div>
                        `;
                    } else {
                        dustStatus.textContent = '‚ö† Poor Air';
                        dustStatus.style.background = 'rgba(239, 68, 68, 0.2)';
                        dustStatus.style.color = '#ef4444';
                        
                        aqiDisplay.innerHTML = `
                            <div class="aqi-circle" style="border: 4px solid #ef4444;">
                                <div class="aqi-value" style="color: #ef4444;">${dust.toFixed(0)}</div>
                                <div class="aqi-label">AQI</div>
                            </div>
                            <div class="aqi-info">
                                <h3 style="color: #ef4444;"><i class="fas fa-exclamation-circle"></i> Poor Air Quality</h3>
                                <p class="aqi-description">Everyone may experience health effects. Sensitive groups should avoid prolonged outdoor exposure.</p>
                            </div>
                        `;
                    }
                }
                
                // Update Air Pressure - NEW!
                if (data.pressure !== undefined) {
                    const pressure = data.pressure;
                    document.getElementById('pressureValue').innerHTML = `${pressure.toFixed(2)}<span class="card-unit">kPa</span>`;
                    
                    // CHANGE THIS LINE:
                    // OLD: const pressurePercent = Math.min((pressure / 110) * 100, 100);
                    // NEW:
                    const pressurePercent = Math.min((pressure / 40) * 100, 100);
                    
                    document.getElementById('pressureBar').style.width = `${pressurePercent}%`;
                    
                    const pressureStatus = document.getElementById('pressureStatus');
                    
                    // ALSO UPDATE THESE RANGES FOR 0-40 kPa:
                    // Normal atmospheric pressure at sea level ‚âà 101 kPa
                    // But this sensor measures 0-40 kPa differential pressure
                    
                    if (pressure < 10) {
                        pressureStatus.textContent = '‚¨áÔ∏è Very Low';
                        pressureStatus.style.background = 'rgba(59, 130, 246, 0.2)';
                        pressureStatus.style.color = '#3b82f6';
                    } else if (pressure > 30) {
                        pressureStatus.textContent = '‚¨ÜÔ∏è Very High';
                        pressureStatus.style.background = 'rgba(239, 68, 68, 0.2)';
                        pressureStatus.style.color = '#ef4444';
                    } else {
                        pressureStatus.textContent = '‚úì Normal Range';
                        pressureStatus.style.background = 'rgba(16, 185, 129, 0.2)';
                        pressureStatus.style.color = '#10b981';
                    }
                }
                
                // Update Solar Tracker
                if (data.tracker) {
                    const angle = data.tracker.angle || 90;
                    document.getElementById('angleValue').innerHTML = `${angle}<span class="card-unit">¬∞</span>`;
                    
                    const anglePercent = ((angle - 30) / 120) * 100;
                    document.getElementById('angleBar').style.width = `${Math.max(0, Math.min(100, anglePercent))}%`;
                    
                    const trackerStatus = document.getElementById('trackerStatus');
                    const status = data.tracker.status || 'UNKNOWN';
                    
                    if (status === 'CENTERED') {
                        trackerStatus.textContent = '‚úì Centered';
                        trackerStatus.style.background = 'rgba(16, 185, 129, 0.2)';
                        trackerStatus.style.color = '#10b981';
                    } else if (status === 'TRACKING') {
                        trackerStatus.textContent = 'üéØ Tracking';
                        trackerStatus.style.background = 'rgba(245, 158, 11, 0.2)';
                        trackerStatus.style.color = '#f59e0b';
                    } else {
                        trackerStatus.textContent = status;
                        trackerStatus.style.background = 'rgba(59, 130, 246, 0.2)';
                        trackerStatus.style.color = '#3b82f6';
                    }
                    
                    const ldrLeft = data.tracker.ldr_left || 0;
                    const ldrRight = data.tracker.ldr_right || 0;
                    
                    document.getElementById('ldrLeft').textContent = ldrLeft;
                    document.getElementById('ldrRight').textContent = ldrRight;
                    
                    document.getElementById('ldrLeftBar').style.width = `${(ldrLeft / 1023) * 100}%`;
                    document.getElementById('ldrRightBar').style.width = `${(ldrRight / 1023) * 100}%`;
                    
                    const diff = data.tracker.diff || 0;
                    document.getElementById('lightDiff').textContent = diff;
                    document.getElementById('trackerAction').textContent = data.tracker.action || 'CENTER';
                    document.getElementById('trackerSystemStatus').textContent = status;
                    
                    let efficiency = 100;
                    if (status === 'TRACKING') {
                        efficiency = Math.max(0, 100 - Math.abs(diff) / 10);
                    } else if (status === 'CENTERED') {
                        efficiency = 100;
                    }
                    document.getElementById('trackerEfficiency').textContent = `${efficiency.toFixed(0)}%`;
                    
                    updateSolarVisualization(angle, ldrLeft, ldrRight);
                }
                
                // Update footer stats
                updateFooterStats();
                
            } catch (error) {
                console.error('Error fetching data:', error);
            }
        }
        
        // Update 3D solar visualization
        function updateSolarVisualization(angle, ldrLeft, ldrRight) {
            const panel = document.getElementById('panelSurface');
            const sun = document.getElementById('sunPosition');
            
            const rotationY = (angle - 90) * 0.8;
            panel.style.transform = `rotateY(${rotationY}deg)`;
            
            const avgLight = (ldrLeft + ldrRight) / 2;
            const lightDiff = ldrLeft - ldrRight;
            
            const sunX = 50 + (lightDiff / 1023) * 30;
            const sunY = 20 + (avgLight / 1023) * 30;
            
            sun.style.left = `${sunX}%`;
            sun.style.top = `${sunY}%`;
            
            const intensity = avgLight / 1023;
            sun.style.opacity = 0.5 + (intensity * 0.5);
        }
        
        // Fetch weather data
        async function updateWeather() {
            try {
                const response = await fetch('/api/weather');
                const weather = await response.json();
                
                document.getElementById('weatherTemp').textContent = `${Math.round(weather.temp)}¬∞C`;
                document.getElementById('weatherDesc').textContent = weather.description;
                document.getElementById('weatherWind').textContent = `${weather.wind_speed} km/h`;
                document.getElementById('weatherHumidity').textContent = `${weather.humidity}%`;
                document.getElementById('weatherPressure').textContent = `${weather.pressure} hPa`;
                document.getElementById('weatherVisibility').textContent = `${weather.visibility} km`;
                
                const iconCode = weather.icon || '01d';
                const weatherIcon = document.getElementById('weatherIcon');
                const iconMap = {
                    '01d': 'fa-sun', '01n': 'fa-moon',
                    '02d': 'fa-cloud-sun', '02n': 'fa-cloud-moon',
                    '03d': 'fa-cloud', '03n': 'fa-cloud',
                    '04d': 'fa-cloud', '04n': 'fa-cloud',
                    '09d': 'fa-cloud-showers-heavy', '09n': 'fa-cloud-showers-heavy',
                    '10d': 'fa-cloud-sun-rain', '10n': 'fa-cloud-moon-rain',
                    '11d': 'fa-bolt', '11n': 'fa-bolt',
                    '13d': 'fa-snowflake', '13n': 'fa-snowflake',
                    '50d': 'fa-smog', '50n': 'fa-smog'
                };
                weatherIcon.innerHTML = `<i class="fas ${iconMap[iconCode] || 'fa-cloud'}"></i>`;
                
            } catch (error) {
                console.error('Weather fetch error:', error);
            }
        }
        
        // Update footer statistics
        function updateFooterStats() {
            document.getElementById('footerReadings').textContent = readingsCount;
            
            const uptimeSeconds = Math.floor((Date.now() - startTime) / 1000);
            const hours = Math.floor(uptimeSeconds / 3600);
            const minutes = Math.floor((uptimeSeconds % 3600) / 60);
            const seconds = uptimeSeconds % 60;
            
            if (hours > 0) {
                document.getElementById('footerUptime').textContent = `${hours}h ${minutes}m`;
            } else if (minutes > 0) {
                document.getElementById('footerUptime').textContent = `${minutes}m ${seconds}s`;
            } else {
                document.getElementById('footerUptime').textContent = `${seconds}s`;
            }
            
            const statusDot = document.getElementById('statusDot');
            document.getElementById('footerStatus').textContent = statusDot.classList.contains('disconnected') ? 'Offline' : 'Online';
        }
        
        // Initialize
        updateData();
        updateWeather();
        
        // Update every 2 seconds
        setInterval(updateData, 2000);
        
        // Update weather every 10 minutes
        setInterval(updateWeather, 600000);
        
        // Auto-refresh if disconnected
        setInterval(() => {
            if (Date.now() - lastUpdateTime > 10000) {
                console.log('Connection timeout, refreshing...');
                updateData();
            }
        }, 5000);
    </script>
    <!-- AI SIDEBAR -->

    <!-- Backdrop -->
    <div id="aiBackdrop" onclick="aiClose()" style="display:none;position:fixed;inset:0;z-index:8000;background:rgba(3,8,20,0.8);backdrop-filter:blur(12px);opacity:0;transition:opacity .35s ease;"></div>

    <!-- FAB ‚Äî clean lightning bolt, sky blue -->
    <button id="aiFab" onclick="aiToggle()" title="AI Analyst" style="position:fixed;bottom:2rem;right:2rem;z-index:8001;width:54px;height:54px;border-radius:16px;border:none;cursor:pointer;background:linear-gradient(145deg,#0b1f3d,#071428);display:flex;align-items:center;justify-content:center;transition:all .3s cubic-bezier(.34,1.56,.64,1);animation:aiFabPulse 4s ease-in-out infinite;">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#38bdf8" stroke-width="1.9" stroke-linecap="round" stroke-linejoin="round">
            <path d="M13 2L4.5 13H11L10 22L20.5 11H14L13 2Z"/>
        </svg>
        <span id="aiFabAlert" style="display:none;position:absolute;top:-3px;right:-3px;width:11px;height:11px;border-radius:50%;background:#f43f5e;border:2px solid #040810;animation:aiFabAlertPing 1.5s ease infinite;"></span>
    </button>

    <!-- AI Sidebar Panel -->
    <aside id="aiSidebar" style="position:fixed;top:0;right:0;bottom:0;z-index:8002;width:420px;max-width:100vw;display:flex;flex-direction:column;background:#06111f;border-left:1px solid rgba(56,189,248,0.08);box-shadow:-28px 0 80px rgba(0,0,0,0.85);transform:translateX(100%);transition:transform .38s cubic-bezier(.4,0,.2,1);">

        <!-- Hairline top accent -->
        <div style="position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent 0%,rgba(56,189,248,0.5) 50%,transparent 100%);"></div>

        <!-- HEADER -->
        <div style="flex-shrink:0;padding:1.35rem 1.35rem 1rem;border-bottom:1px solid rgba(255,255,255,0.04);">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem;">

                <!-- Identity -->
                <div style="display:flex;align-items:center;gap:.8rem;">
                    <div style="position:relative;flex-shrink:0;">
                        <div style="width:38px;height:38px;border-radius:11px;background:linear-gradient(145deg,#0c2d52,#071428);border:1px solid rgba(56,189,248,0.2);display:flex;align-items:center;justify-content:center;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#38bdf8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M13 2L4.5 13H11L10 22L20.5 11H14L13 2Z"/>
                            </svg>
                        </div>
                        <span id="aiOnlineDot" style="position:absolute;bottom:-2px;right:-2px;width:9px;height:9px;border-radius:50%;background:#22d3ee;border:2px solid #06111f;transition:background .4s ease;"></span>
                    </div>
                    <div>
                        <div style="font-family:'DM Sans',sans-serif;font-size:.88rem;font-weight:700;color:#e0f2fe;display:flex;align-items:center;gap:.4rem;letter-spacing:.03px;">
                            IoT Analyst
                            <span style="font-size:.57rem;font-weight:600;letter-spacing:.5px;color:#38bdf8;background:rgba(56,189,248,0.1);border:1px solid rgba(56,189,248,0.2);padding:.06rem .36rem;border-radius:4px;">AI</span>
                        </div>
                        <div style="font-size:.63rem;color:#1d4060;margin-top:.16rem;letter-spacing:.15px;font-family:'DM Sans',sans-serif;">
                            <span style="color:#22d3ee;font-size:.48rem;vertical-align:middle;">‚óè</span>&ensp;ollama ¬∑ local inference
                        </div>
                    </div>
                </div>

                <!-- Close -->
                <button onclick="aiClose()" style="width:28px;height:28px;border-radius:7px;border:1px solid rgba(255,255,255,0.05);background:transparent;color:#1e3a5f;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:.75rem;transition:all .15s;font-family:sans-serif;" onmouseover="this.style.background='rgba(244,63,94,0.09)';this.style.color='#f43f5e'" onmouseout="this.style.background='transparent';this.style.color='#1e3a5f'">‚úï</button>
            </div>

            <!-- Quick chips -->
            <div style="display:flex;gap:.3rem;flex-wrap:wrap;">
                <button class="ai-chip ai-chip-danger" onclick="aiQuick('anomaly')"><i class="fas fa-bolt"></i> Anomaly</button>
                <button class="ai-chip ai-chip-amber"  onclick="aiQuick('report')"><i class="fas fa-file-lines"></i> Report</button>
                <button class="ai-chip"                onclick="aiQuick('status')"><i class="fas fa-gauge-high"></i> Status</button>
                <button class="ai-chip"                onclick="aiQuick('solar')"><i class="fas fa-solar-panel"></i> Solar</button>
                <button class="ai-chip"                onclick="aiQuick('air')"><i class="fas fa-wind"></i> Air</button>
                <button class="ai-chip ai-chip-muted"  onclick="aiClear()"><i class="fas fa-rotate-left"></i> Clear</button>
            </div>
        </div>

        <!-- MESSAGES -->
        <div id="aiMessages" style="flex:1;overflow-y:auto;padding:.95rem;display:flex;flex-direction:column;gap:.65rem;scroll-behavior:smooth;">
            <div id="aiWelcome" style="margin:auto;text-align:center;padding:2.5rem 1.5rem;max-width:270px;">
                <div style="width:50px;height:50px;border-radius:14px;margin:0 auto 1rem;background:rgba(56,189,248,0.05);border:1px solid rgba(56,189,248,0.1);display:flex;align-items:center;justify-content:center;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="rgba(56,189,248,0.45)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M13 2L4.5 13H11L10 22L20.5 11H14L13 2Z"/>
                    </svg>
                </div>
                <div style="font-family:'DM Sans',sans-serif;font-size:.84rem;font-weight:600;color:#334155;margin-bottom:.42rem;">Environmental Analyst</div>
                <div style="font-family:'DM Sans',sans-serif;font-size:.72rem;color:#1e3a5f;line-height:1.8;">I fetch live sensor data before every reply ‚Äî ask about readings, trends, anomalies, or get a daily report.</div>
            </div>
        </div>

        <!-- STATUS BAR -->
        <div style="flex-shrink:0;padding:.4rem 1.2rem;display:flex;align-items:center;gap:.45rem;border-top:1px solid rgba(255,255,255,0.03);">
            <div id="aiStatusDot" style="width:5px;height:5px;border-radius:50%;background:#22d3ee;flex-shrink:0;transition:background .3s ease;"></div>
            <span id="aiStatusText" style="font-size:.62rem;color:#1e3a5f;letter-spacing:.25px;font-family:'Courier New',monospace;">ready ¬∑ waiting</span>
        </div>

        <!-- INPUT -->
        <div style="flex-shrink:0;padding:.8rem .85rem .9rem;background:rgba(0,0,0,0.3);border-top:1px solid rgba(255,255,255,0.04);">
            <div style="display:flex;gap:.5rem;align-items:flex-end;">
                <textarea id="aiInput" rows="1" placeholder="Ask about your sensors‚Ä¶"
                    style="flex:1;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);border-radius:11px;padding:.65rem .9rem;color:#bae6fd;font-size:.8rem;font-family:'DM Sans',sans-serif;resize:none;outline:none;min-height:40px;max-height:110px;line-height:1.55;transition:border-color .2s ease;caret-color:#38bdf8;"
                    onfocus="this.style.borderColor='rgba(56,189,248,0.28)'"
                    onblur="this.style.borderColor='rgba(255,255,255,0.06)'"
                    onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();aiSend();}"
                    oninput="this.style.height='auto';this.style.height=Math.min(this.scrollHeight,110)+'px';"></textarea>
                <button id="aiSendBtn" onclick="aiSend()"
                    style="width:40px;height:40px;border-radius:10px;flex-shrink:0;border:1px solid rgba(56,189,248,0.18);background:rgba(56,189,248,0.06);color:#38bdf8;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:.82rem;transition:all .16s ease;"
                    onmouseover="this.style.background='rgba(56,189,248,0.14)';this.style.borderColor='rgba(56,189,248,0.35)';this.style.transform='scale(1.07)'"
                    onmouseout="this.style.background='rgba(56,189,248,0.06)';this.style.borderColor='rgba(56,189,248,0.18)';this.style.transform='scale(1)'">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
            <div style="text-align:center;margin-top:.4rem;font-size:.58rem;color:#0d1f33;font-family:'DM Sans',sans-serif;letter-spacing:.1px;">
                Enter to send &middot; Shift+Enter newline &middot; Ollama local
            </div>
        </div>
    </aside>

    <!-- AI STYLES -->
    <style>
        /* FAB */
        @keyframes aiFabPulse {
            0%,100% { box-shadow:0 0 0 1px rgba(56,189,248,0.12),0 6px 26px rgba(0,0,0,0.65),0 0 32px rgba(56,189,248,0.05); }
            50%      { box-shadow:0 0 0 1px rgba(56,189,248,0.25),0 8px 32px rgba(0,0,0,0.65),0 0 52px rgba(56,189,248,0.1); }
        }
        @keyframes aiFabAlertPing {
            0%,100% { box-shadow:0 0 0 0 rgba(244,63,94,0.5); }
            60%     { box-shadow:0 0 0 5px rgba(244,63,94,0); }
        }
        #aiFab:hover {
            transform:scale(1.1) translateY(-2px) !important;
            animation:none !important;
            box-shadow:0 0 0 1px rgba(56,189,248,0.4),0 10px 38px rgba(0,0,0,0.7),0 0 60px rgba(56,189,248,0.15) !important;
        }

        /* Chips */
        .ai-chip {
            font-family:'DM Sans',sans-serif;
            font-size:.67rem;font-weight:600;letter-spacing:.05px;
            padding:.28rem .72rem;border-radius:6px;
            border:1px solid rgba(255,255,255,0.06);
            background:rgba(255,255,255,0.02);
            color:#2d4a66;cursor:pointer;
            transition:all .13s ease;
            display:inline-flex;align-items:center;gap:.28rem;
            white-space:nowrap;
        }
        .ai-chip:hover { background:rgba(56,189,248,0.07);border-color:rgba(56,189,248,0.2);color:#38bdf8; }
        .ai-chip-danger { border-color:rgba(244,63,94,0.15);color:#f87171; }
        .ai-chip-danger:hover { background:rgba(244,63,94,0.08);border-color:rgba(244,63,94,0.3);color:#f43f5e; }
        .ai-chip-amber  { border-color:rgba(251,146,60,0.15);color:#fb923c; }
        .ai-chip-amber:hover  { background:rgba(251,146,60,0.08);border-color:rgba(251,146,60,0.3);color:#f97316; }
        .ai-chip-muted  { border-color:rgba(255,255,255,0.03);color:#1a3048; }
        .ai-chip-muted:hover  { color:#2d4a66; }

        /* Message rows */
        @keyframes aiMsgIn { from{opacity:0;transform:translateY(5px)} to{opacity:1;transform:translateY(0)} }
        .ai-row { display:flex;gap:.5rem;animation:aiMsgIn .2s ease; }
        .ai-row-user { flex-direction:row-reverse; }

        /* Avatars */
        .ai-av { width:25px;height:25px;border-radius:7px;flex-shrink:0;display:flex;align-items:center;justify-content:center;margin-top:2px; }
        .ai-row-ai   .ai-av { background:rgba(56,189,248,0.07);border:1px solid rgba(56,189,248,0.1);color:#38bdf8; }
        .ai-row-user .ai-av { background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);color:#2d4a66; }

        /* Bubble wrappers */
        .ai-bwrap { display:flex;flex-direction:column;max-width:87%; }
        .ai-row-user .ai-bwrap { align-items:flex-end; }

        /* Bubbles */
        .ai-bubble { padding:.65rem .88rem;font-size:.79rem;line-height:1.75;word-break:break-word; }
        .ai-row-ai   .ai-bubble {
            font-family:'DM Sans',sans-serif;
            background:rgba(10,26,52,0.6);
            border:1px solid rgba(56,189,248,0.08);
            border-radius:3px 12px 12px 12px;
            color:#bae6fd;
        }
        .ai-row-user .ai-bubble {
            font-family:'DM Sans',sans-serif;
            background:rgba(10,20,40,0.7);
            border:1px solid rgba(255,255,255,0.06);
            border-radius:12px 3px 12px 12px;
            color:#4a6a8a;
        }

        /* Markdown */
        .ai-bubble .mh2  { display:block;color:#38bdf8;font-weight:700;font-size:.8rem;margin:.65rem 0 .27rem;letter-spacing:.1px; }
        .ai-bubble .mh3  { display:block;color:#7dd3fc;font-weight:600;font-size:.76rem;margin:.48rem 0 .18rem; }
        .ai-bubble strong{ color:#e0f2fe;font-weight:700; }
        .ai-bubble em    { color:#7dd3fc;font-style:italic; }
        .ai-bubble code  { background:rgba(0,0,0,0.38);padding:.07rem .33rem;border-radius:3px;color:#22d3ee;font-size:.72rem;font-family:'Courier New',monospace; }
        .ai-bubble .mli  { display:block;padding-left:.85rem;margin:.1rem 0;color:#8aabb5;position:relative; }
        .ai-bubble .mli::before { content:'‚Ä∫';position:absolute;left:0;color:#38bdf8;font-size:.85rem;line-height:1.55; }
        .ai-bubble .msep { display:block;border:none;border-top:1px solid rgba(56,189,248,0.07);margin:.48rem 0; }

        /* Timestamps */
        .ai-ts { font-size:.58rem;color:#0f2030;margin-top:.16rem;padding:0 .1rem; }
        .ai-row-user .ai-ts { text-align:right; }

        /* Typing indicator */
        @keyframes aiTypingDot {
            0%,60%,100% { transform:translateY(0);opacity:.25; }
            30%          { transform:translateY(-4px);opacity:1; }
        }
        .ai-typing { display:flex;gap:3.5px;padding:.58rem .82rem;background:rgba(10,26,52,0.5);border:1px solid rgba(56,189,248,0.07);border-radius:3px 12px 12px 12px;width:fit-content; }
        .ai-typing span { width:5px;height:5px;border-radius:50%;background:#38bdf8;animation:aiTypingDot 1.1s ease-in-out infinite; }
        .ai-typing span:nth-child(2){animation-delay:.18s}
        .ai-typing span:nth-child(3){animation-delay:.36s}

        /* Scrollbar */
        #aiMessages::-webkit-scrollbar { width:2px; }
        #aiMessages::-webkit-scrollbar-thumb { background:rgba(56,189,248,0.09);border-radius:2px; }
    </style>

    <!-- AI JS -->
    <script>
    (function(){
        'use strict';

        const OLLAMA_URL = 'http://localhost:11434';
        const MODEL      = 'fervent_mcclintock/Qwen2.5-Coder-0.5B-Instruct:Q4_K_M';
        const DATA_URL   = '/api/data';
        const HIST_URL   = '/api/history/24';
        const ALERT_URL  = '/api/alerts/20';
        let open = false, busy = false;

        // Open / Close
        window.aiToggle = () => open ? aiClose() : aiOpen();
        window.aiOpen = function() {
            open = true;
            document.getElementById('aiSidebar').style.transform = 'translateX(0)';
            const bd = document.getElementById('aiBackdrop');
            bd.style.display = 'block'; requestAnimationFrame(() => bd.style.opacity = '1');
            const fab = document.getElementById('aiFab');
            fab.style.transform = 'scale(0.88) rotate(90deg)'; fab.style.animation = 'none';
            document.getElementById('aiFabAlert').style.display = 'none';
            setTimeout(() => document.getElementById('aiInput').focus(), 380);
        };
        window.aiClose = function() {
            open = false;
            document.getElementById('aiSidebar').style.transform = 'translateX(100%)';
            const bd = document.getElementById('aiBackdrop');
            bd.style.opacity = '0'; setTimeout(() => bd.style.display = 'none', 350);
            const fab = document.getElementById('aiFab');
            fab.style.transform = ''; fab.style.animation = 'aiFabPulse 4s ease-in-out infinite';
        };
        document.addEventListener('keydown', e => { if(e.key === 'Escape' && open) aiClose(); });

        // Quick actions
        const QUICK = {
            anomaly: 'Analyze ALL sensor readings for anomalies.\n## Current Status\n## Anomalies Found\n## Cross-Sensor Correlations\n## System Health (x/10)\n## Action Items',
            report:  'Daily Environmental Briefing:\n## Summary\n## Temperature & Humidity\n## Air Quality (vs WHO 15 ¬µg/m¬≥)\n## Pressure\n## Solar Tracker\n## Alerts\n## Recommendations',
            status:  'Quick check: are all 5 sensors reading normally right now?',
            solar:   'How is the solar tracker performing? Is the panel angle optimal?',
            air:     'Analyze air quality vs WHO safe limits. Any health concerns?',
        };
        const QLABEL = { anomaly:'‚ö° Anomaly scan‚Ä¶', report:'üìã Daily report‚Ä¶', status:'üì° Status check‚Ä¶', solar:'‚òÄÔ∏è Solar analysis‚Ä¶', air:'üí® Air quality‚Ä¶' };
        window.aiQuick = k => { if(!QUICK[k] || busy) return; addUserBubble(QLABEL[k]); callOllama(QUICK[k]); };
        window.aiSend  = function() {
            const inp = document.getElementById('aiInput'), txt = inp.value.trim();
            if(!txt || busy) return; inp.value = ''; inp.style.height = 'auto';
            addUserBubble(txt); callOllama(txt);
        };
        window.aiClear = function() {
            document.getElementById('aiMessages').innerHTML =
                '<div id="aiWelcome" style="margin:auto;text-align:center;padding:2rem;font-family:sans-serif;">' +
                '<div style="font-size:.83rem;font-weight:600;color:#334155;margin-bottom:.3rem;">Cleared</div>' +
                '<div style="font-size:.71rem;color:#1e3a5f;">Type a question or use a quick action.</div></div>';
        };

        // Data fetch
        async function fetchCtx() {
            const [live,hist,alerts] = await Promise.all([sf(DATA_URL),sf(HIST_URL),sf(ALERT_URL)]);
            return {live,hist,alerts};
        }
        async function sf(u) { try { return await (await fetch(u)).json(); } catch { return null; } }

        function buildPrompt({live,hist,alerts}) {
            let lb = 'No live data.';
            if(live?.temperature != null)
                lb = `Temp:${live.temperature}¬∞C|Humidity:${live.humidity}%|Dust:${live.dust}¬µg/m¬≥|Pressure:${live.pressure}kPa(0-40kPa diff,NOT atmospheric)|Solar:angle=${live.tracker?.angle}¬∞ LDR-L=${live.tracker?.ldr_left} LDR-R=${live.tracker?.ldr_right} diff=${live.tracker?.diff} status=${live.tracker?.status}`;
            let hb = 'No history.';
            if(Array.isArray(hist) && hist.length) {
                const v = k => hist.map(r=>r[k]).filter(x=>x!=null);
                const avg = a => a.length ? (a.reduce((s,x)=>s+x,0)/a.length).toFixed(1) : 'N/A';
                const rng = a => a.length ? `${Math.min(...a).toFixed(1)}-${Math.max(...a).toFixed(1)}` : 'N/A';
                const T=v('temperature'),H=v('humidity'),D=v('dust'),P=v('pressure');
                hb = `${hist.length}readings. T:avg${avg(T)} ${rng(T)}¬∞C|H:avg${avg(H)} ${rng(H)}%|D:avg${avg(D)} ${rng(D)}¬µg/m¬≥|P:avg${avg(P)} ${rng(P)}kPa`;
            }
            let ab = 'None.';
            if(Array.isArray(alerts) && alerts.length) ab = alerts.slice(0,6).map(a=>`[${a.level}]${a.message}`).join('|');
            return `IoT AI Analyst, Muscat Oman. Sensors:DHT11(temp+hum)|Sharp GP2Y1014(dust)|MPS20N0040D(diff pressure 0-40kPa)|Dual LDR+Servo(solar 30-150¬∞). Thresholds:T warn>35 crit>40¬∞C|H warn>70or<30 crit>80%|D warn>140 crit>180(WHO=15)|P warn>30or<5 crit>35or<2kPa. LIVE:${lb} 24H:${hb} ALERTS:${ab}. Use ## headers and - bullets. Be precise and actionable.`;
        }

        // Ollama streaming
        async function callOllama(prompt) {
            if(busy) return; setBusy(true);
            const ctx = await fetchCtx(); showTyping();
            try {
                const res = await fetch(`${OLLAMA_URL}/api/chat`, {
                    method:'POST', headers:{'Content-Type':'application/json'},
                    body: JSON.stringify({ model:MODEL, stream:true,
                        messages:[{role:'system',content:buildPrompt(ctx)},{role:'user',content:prompt}],
                        options:{temperature:0.3, num_predict:700} })
                });
                if(!res.ok) throw new Error(`Ollama ${res.status}`);
                removeTyping();
                const bubble = addAIBubble('');
                const reader = res.body.getReader(), dec = new TextDecoder(); let full = '';
                while(true) {
                    const {done,value} = await reader.read(); if(done) break;
                    dec.decode(value,{stream:true}).split('\n').forEach(line => {
                        if(!line.trim()) return;
                        try { const j=JSON.parse(line); if(j.message?.content){ full+=j.message.content; bubble.innerHTML=md(full); scrollBot(); } } catch{}
                    });
                }
                setStatus('ready','ready');
            } catch(err) {
                removeTyping();
                const conn = err.message.includes('fetch')||err.message.includes('Failed')||err.message.includes('Network');
                addAIBubble(conn
                    ? `**Cannot reach Ollama**\n\n- Run \`ollama serve\` in a terminal\n- Run \`ollama pull ${MODEL}\`\n- CORS fix: \`OLLAMA_ORIGINS=* ollama serve\``
                    : `**Error:** ${err.message}`);
                setStatus('error','error ¬∑ check terminal');
            }
            setBusy(false);
        }

        // DOM helpers
        function addUserBubble(text) {
            rmWelcome();
            const msgs = document.getElementById('aiMessages');
            const row = document.createElement('div'); row.className = 'ai-row ai-row-user';
            const av = document.createElement('div'); av.className = 'ai-av'; av.innerHTML = '<i class="fas fa-user" style="font-size:.58rem;"></i>';
            const bw = document.createElement('div'); bw.className = 'ai-bwrap';
            const b = document.createElement('div'); b.className = 'ai-bubble'; b.innerHTML = esc(text);
            const ts = document.createElement('div'); ts.className = 'ai-ts'; ts.textContent = tnow();
            bw.append(b, ts); row.append(av, bw); msgs.appendChild(row); scrollBot();
        }
        function addAIBubble(text) {
            rmWelcome();
            const msgs = document.getElementById('aiMessages');
            const row = document.createElement('div'); row.className = 'ai-row ai-row-ai';
            const av = document.createElement('div'); av.className = 'ai-av';
            av.innerHTML = '<svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.4" stroke-linecap="round"><path d="M13 2L4.5 13H11L10 22L20.5 11H14L13 2Z"/></svg>';
            const bw = document.createElement('div'); bw.className = 'ai-bwrap';
            const b = document.createElement('div'); b.className = 'ai-bubble'; b.innerHTML = md(text);
            const ts = document.createElement('div'); ts.className = 'ai-ts'; ts.textContent = tnow();
            bw.append(b, ts); row.append(av, bw); msgs.appendChild(row); scrollBot();
            return b;
        }
        function showTyping() {
            removeTyping();
            const msgs = document.getElementById('aiMessages');
            const row = document.createElement('div'); row.id = 'aiTyping'; row.className = 'ai-row ai-row-ai';
            const av = document.createElement('div'); av.className = 'ai-av';
            av.innerHTML = '<svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.4" stroke-linecap="round"><path d="M13 2L4.5 13H11L10 22L20.5 11H14L13 2Z"/></svg>';
            const t = document.createElement('div'); t.className = 'ai-typing'; t.innerHTML = '<span></span><span></span><span></span>';
            row.append(av, t); msgs.appendChild(row); scrollBot();
        }
        function removeTyping() { document.getElementById('aiTyping')?.remove(); }
        function rmWelcome()    { document.getElementById('aiWelcome')?.remove(); }
        function scrollBot()    { const m=document.getElementById('aiMessages'); if(m) m.scrollTop=m.scrollHeight; }
        function setBusy(v) {
            busy = v;
            const btn = document.getElementById('aiSendBtn'), dot = document.getElementById('aiOnlineDot');
            if(btn) { btn.disabled=v; btn.innerHTML=v?'<i class="fas fa-circle-notch fa-spin" style="font-size:.72rem;color:#1e3a5f;"></i>':'<i class="fas fa-paper-plane"></i>'; }
            if(dot) dot.style.background = v ? '#f59e0b' : '#22d3ee';
            if(v) setStatus('thinking','thinking‚Ä¶');
        }
        function setStatus(s,t) {
            const c={ready:'#22d3ee',thinking:'#f59e0b',error:'#f43f5e'};
            const dot=document.getElementById('aiStatusDot'), txt=document.getElementById('aiStatusText');
            if(dot) dot.style.background = c[s]||'#334155'; if(txt) txt.textContent = t;
        }
        function md(t) {
            return t.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
                .replace(/^## (.+)$/gm,'<span class="mh2">$1</span>')
                .replace(/^### (.+)$/gm,'<span class="mh3">$1</span>')
                .replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>')
                .replace(/\*(.+?)\*/g,'<em>$1</em>')
                .replace(/`([^`]+)`/g,'<code>$1</code>')
                .replace(/^---$/gm,'<span class="msep"></span>')
                .replace(/^[-‚Ä¢*] (.+)$/gm,'<span class="mli">$1</span>')
                .replace(/^\d+\. (.+)$/gm,'<span class="mli">$1</span>')
                .replace(/\n\n/g,'<br><br>').replace(/\n/g,'<br>');
        }
        function esc(t) { return t.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>'); }
        function tnow()  { return new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}); }

        // Hook into existing alert system
        window.notifyAIAlert = function(level) {
            if(!open && level === 'critical') document.getElementById('aiFabAlert').style.display = 'block';
        };
        console.log('[IoT AI] ready | model:', MODEL);
    })();
    </script>

</body>
</html>
